<div class="layuimini-container">
    <div class="layuimini-main">

        <blockquote class="layui-elem-quote layui-text">
            我是提示
        </blockquote>

        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 20px;">
            <legend>爬取</legend>
        </fieldset>

        <form class="layui-form" action="" lay-filter="example">
            <div class="layui-form-item">
                <label class="layui-form-label">关键字</label>
                <div class="layui-input-block">
                    <input type="text" name="keyword" lay-verify="required" lay-reqtext="关键字是必填项哦。" placeholder="请输入关键字"
                        autocomplete="off" class="layui-input">
                </div>
            </div>
            <!-- <div class="layui-form-item">
                <label class="layui-form-label">位置</label>
                <div class="layui-input-block">
                    <input type="text" name="position" lay-verify="required" lay-reqtext="位置是必填项哦。" placeholder="请输入关键字"
                        autocomplete="off" class="layui-input">
                </div>
            </div> -->
            <div class="layui-form-item">
                <label class="layui-form-label">位置</label>
                <div class="layui-input-inline">
                    <select id="province" name="province" lay-filter="province">
                        <option value="">请选择省或直辖市</option>
                    </select>
                </div>
                <div class="layui-input-inline">
                    <select id="city" name="city">
                        <option value="">请选择地级市</option>
                    </select>
                </div>
                <!-- <div class="layui-input-inline">
                    <button class="layui-btn" type=button id="auto-gain-position">自动获取位置</button>
                </div> -->
            </div>
            <div class="layui-form-item">
                <div class="layui-input-block">
                    <button class="layui-btn" lay-submit="" lay-filter="demo1">开始爬取</button>
                    <button type="reset" class="layui-btn layui-btn-primary">重置</button>
                </div>
            </div>
        </form>
        <div id="div-chart"></div>
    </div>
</div>
<!-- <script src="js/lay-module/echarts/macarons.js" charset="utf-8"></script> -->
<script>
    layui.use(['form', 'layedit', 'laydate', 'jquery', 'echarts'], function () {
        var form = layui.form
            , layer = layui.layer
            , layedit = layui.layedit
            , laydate = layui.laydate
            , echarts = layui.echarts
            , $ = layui.$;
        let provinces = [];
        var loader = {//读取遮罩
            ui: null,
            show: function () {
                this.ui = layer.load(3, { shade: [0.6, '#def'] });
            },
            close: function () {
                layer.close(this.ui);
            }
        };
        /**
         * 初始化表单，要加上，不然刷新部分组件可能会不加载
         */
        form.render();

        /**初始化位置*/
        const initPositions = function () {
            $.ajax({
                type: "get",
                url: "/positions/structured",
                dataType: "json",
                success: function (response) {
                    provinces = response.data;
                    // console.log(JSON.stringify(provinces));
                    // console.log(province.length);
                    provinces.forEach(province => {
                        // console.log(province.name);
                        $("#province").append(new Option(province.name, province.code));
                    });
                    form.render("select");
                }
            });
        }

        initPositions();

        //监听“自动获取位置”按钮
        // $("#auto-gain-position").on("click", function () {
        //     const ip=returnCitySN['cip'];
        //     // alert("IP地址是：" + returnCitySN['cip'] + "    " + "城市名字：" + returnCitySN['cname']);
        //     var url = "http://ip.taobao.com/service/getIpInfo.php?ip=" + ip;
        //     $.getJSON(url, function (json) {
        //         var myprovince2 = json.data.area;
        //         var mycity2 = json.data.region;
        //         alert("您所在的城市是：" + myprovince2 + mycity2);
        //     });
        // });

        /**省联动市*/
        form.on("select(province)", function (data) {
            const province = data.value;
            provinces.forEach(p => {
                if (p.code == province) {
                    $("#city").empty();
                    $("#city").append(new Option("请选择地级市", ""));
                    p.positions.forEach(city => {
                        $("#city").append(new Option(city.name, city.code));
                    });
                }
            });
            form.render("select");
        });

        //监听提交
        form.on('submit(demo1)', function (data) {
            loader.show();
            // layer.alert(JSON.stringify(data.field), {
            //     title: '最终的提交信息'
            // })
            const province = data.field.province;
            const city = data.field.city;
            let position;
            if (province != null && city != null) {
                position = city;
            } else if (province != null && city == null) {
                position = province;
            }
            const keyword = data.field.keyword;
            console.log(JSON.stringify(data.field));
            //提交
            $.ajax({
                type: "get",
                url: "/job",
                data: "keyword=" + keyword + "&position=" + position,
                dataType: "json",
                success: function (response) {
                    if (response.state == 200) {
                        $("#div-chart").show();
                        initPie(response.data);
                        loader.close();
                    }
                    layer.alert(response.message);
                },
                error: function (jqXHR, textStatus, errorThrown) {
                	loader.close();
                    layer.alert("抱歉，请求失败！以下是错误信息：\n当前状态：" + jqXHR.readyState + "；HTTP状态码：" + jqXHR.status + "；状态码错误信息：" + jqXHR.statusText + "；状态：" + textStatus);
                }
            });
            return false;
        });

        /**饼图*/
        const initPie = function (data) {
            var legendData = [];
            data.technologyCounter.forEach(e => {
                legendData.push(e.name);
            });
            var chart = echarts.init(document.getElementById('div-chart'), "walden");
            option = {
                title: {
                    text: '技术栈饼图',
                    left: 'center',
                    // top: 20,
                    // textStyle: {
                    //     color: '#ccc'
                    // }
                },
                tooltip: {
                    trigger: 'item',
                    formatter: "{a} <br/>{b}: {c} ({d}%)"
                },
                legend: {
                    orient: 'vertical',
                    x: 'left',
                    type: 'scroll',
                    data: legendData
                },
                toolbox: {
                    show: true,
                    feature: {
                        // mark: { show: true },
                        dataView: { show: true, readOnly: true },
                        restore: { show: true },
                        saveAsImage: { show: true }
                    }
                },
                series: [
                    //内圈
                    {
                        name: '次数',
                        type: 'pie',
                        selectedMode: 'single',
                        minAngle: 5,
                        avoidLabelOverlap: true,
                        radius: [0, '45%'],

                        label: {
                            normal: {
                                position: 'inner'
                            }
                        },
                        labelLine: {
                            normal: {
                                show: false
                            }
                        },
                        data: data.technologyTypeCounter
                    },
                    //外圈
                    {
                        name: '次数',
                        type: 'pie',
                        radius: ['50%', '80%'],
                        minAngle: 3,
                        avoidLabelOverlap: true,
                        label: {
                            normal: {
                                // formatter: '{a|{a}}{abg|}\n{hr|}\n  {b|{b}：}{c}  {per|{d}%}  ',
                                formatter: '  {b}：{c} - {d}%  ',
                                backgroundColor: '#eee',
                                borderColor: '#aaa',
                                borderWidth: 1,
                                borderRadius: 4,
                                // shadowBlur:3,
                                // shadowOffsetX: 2,
                                // shadowOffsetY: 2,
                                // shadowColor: '#999',
                                // padding: [0, 7],
                                rich: {
                                    a: {
                                        color: '#999',
                                        lineHeight: 22,
                                        align: 'center'
                                    },
                                    // abg: {
                                    //     backgroundColor: '#333',
                                    //     width: '100%',
                                    //     align: 'right',
                                    //     height: 22,
                                    //     borderRadius: [4, 4, 0, 0]
                                    // },
                                    hr: {
                                        borderColor: '#aaa',
                                        width: '100%',
                                        borderWidth: 0.5,
                                        height: 0
                                    },
                                    b: {
                                        fontSize: 16,
                                        lineHeight: 33
                                    },
                                    per: {
                                        color: '#eee',
                                        backgroundColor: '#334455',
                                        padding: [2, 4],
                                        borderRadius: 2
                                    }
                                }
                            }
                        },
                        data: data.technologyCounter
                    }
                ]
            };
            chart.setOption(option);

        }
        //表单初始赋值
        form.val('example', {
            "like[write]": true //复选框选中状态
            , "close": true //开关状态
            , "keyword": "java"
            , "position": "泉州"
        })
    });
</script>
<style type="text/css">
    #div-chart {
        display: none;
        width: auto;
        height: 40vw;
    }
</style>